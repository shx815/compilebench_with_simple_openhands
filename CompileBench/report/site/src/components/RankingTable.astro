---
interface Props {
  data: Array<any>;
  numTries: number;
  type: 'model' | 'task';
  containerId?: string;
  showDescriptionsBelowName?: boolean;
}

const { data, numTries, type, containerId = `ranking-${type}`, showDescriptionsBelowName = false } = Astro.props;
---

<div id={containerId} class="overflow-hidden mb-8"></div>

<script define:vars={{ data, numTries, type, containerId, showDescriptionsBelowName }}>
  // Unified ranking table renderer - descending only
  class RankingRenderer {
    constructor(data, type) {
      this.data = data.map((item, idx) => ({ ...item, rank: idx + 1 }));
      this.type = type;
      this.sortColumn = type === 'model' ? 'tasks_passed_rate' : 'models_passed_rate';
    }

    sort(column) {
      this.sortColumn = column;

      // Always sort descending for ranking
      this.data.sort((a, b) => {
        if (this.type === 'model') {
          const primaryVal = column === 'pass1' ? b.attempts_passed_rate - a.attempts_passed_rate : b.tasks_passed_rate - a.tasks_passed_rate;
          if (primaryVal !== 0) return primaryVal;
          const secondaryVal = column === 'pass1' ? b.tasks_passed_rate - a.tasks_passed_rate : b.attempts_passed_rate - a.attempts_passed_rate;
          if (secondaryVal !== 0) return secondaryVal;
          return a.model.localeCompare(b.model);
        } else {
          const primaryVal = column === 'pass1' ? b.attempts_passed_rate - a.attempts_passed_rate : b.models_passed_rate - a.models_passed_rate;
          if (primaryVal !== 0) return primaryVal;
          const secondaryVal = column === 'pass1' ? b.models_passed_rate - a.models_passed_rate : b.attempts_passed_rate - a.attempts_passed_rate;
          if (secondaryVal !== 0) return secondaryVal;
          return a.task_name.localeCompare(b.task_name);
        }
      });

      // Update ranks
      this.data.forEach((row, idx) => {
        row.rank = idx + 1;
      });

      this.render();
    }

    render() {
      const container = document.getElementById(containerId);

      const table = document.createElement('table');
      table.className = 'table-base';

      // Colgroup
      const colgroup = document.createElement('colgroup');
      colgroup.innerHTML = '<col class="w-8"><col class="sm:w-80"><col class="hidden sm:table-column">';
      table.appendChild(colgroup);

      // Header
      const thead = document.createElement('thead');
      thead.className = 'table-header';
      const tr = document.createElement('tr');
      tr.className = 'table-header-row';

      // Rank column
      const th1 = document.createElement('th');
      th1.className = 'table-header-cell table-header-cell-first table-cell-right';
      th1.textContent = '#';
      tr.appendChild(th1);

      // Name column (Model or Task)
      const th2 = document.createElement('th');
      th2.className = 'table-header-cell table-header-cell-rest table-cell-left';
      th2.textContent = this.type === 'model' ? 'Model' : 'Task name';
      tr.appendChild(th2);

      // Success rate column with two sortable buttons (hidden on mobile)
      const th3 = document.createElement('th');
      th3.className = 'table-header-cell table-header-cell-rest table-cell-right hidden sm:table-cell';

      const btn1 = document.createElement('button');
      btn1.className = 'table-sort-button';
      btn1.textContent = 'pass@1';
      btn1.onclick = () => this.sort('pass1');
      const arrow1 = document.createElement('span');
      arrow1.className = `table-sort-arrow ${this.sortColumn === 'pass1' ? 'table-sort-arrow-active' : 'table-sort-arrow-inactive'}`;
      arrow1.textContent = '↓';
      btn1.appendChild(arrow1);

      const separator = document.createElement('span');
      separator.className = 'text-slate-400 mx-1';
      separator.textContent = '/';

      const btn2 = document.createElement('button');
      btn2.className = 'table-sort-button';
      btn2.textContent = `pass@${numTries}`;
      btn2.onclick = () => this.sort('pass3');
      const arrow2 = document.createElement('span');
      const pass3Column = this.type === 'model' ? 'tasks_passed_rate' : 'models_passed_rate';
      arrow2.className = `table-sort-arrow ${this.sortColumn === pass3Column ? 'table-sort-arrow-active' : 'table-sort-arrow-inactive'}`;
      arrow2.textContent = '↓';
      btn2.appendChild(arrow2);

      th3.appendChild(btn1);
      th3.appendChild(separator);
      th3.appendChild(btn2);
      tr.appendChild(th3);

      thead.appendChild(tr);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement('tbody');

      this.data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.className = idx === this.data.length - 1 ? 'border-slate-200' : 'border-slate-200 border-b';

        // Rank cell
        const td1 = document.createElement('td');
        td1.className = 'table-cell table-cell-first table-cell-right';
        td1.style.borderLeft = 'none';
        td1.textContent = row.rank;
        tr.appendChild(td1);

        // Name cell (Model or Task)
        const td2 = document.createElement('td');
        td2.className = 'table-cell table-cell-left pl-2 pr-2';

        const pass1Pct = Math.round(row.attempts_passed_rate * 100);
        const pass3Pct = this.type === 'model'
          ? Math.round(row.tasks_passed_rate * 100)
          : Math.round(row.models_passed_rate * 100);
        const hue = Math.round(row.attempts_passed_rate * 100);

        // Progress bar HTML for mobile (shown below name)
        const progressBarMobile = `
          <div class="sm:hidden mt-1.5">
            <div class="text-right text-slate-800 tabular-nums text-xs mb-0.5">
              ${pass1Pct}% <span class="text-slate-500"> / ${pass3Pct}%</span>
            </div>
            <div class="w-full bg-slate-200 h-2.5 flex">
              <div class="h-2.5" style="width: ${pass1Pct}%; background-color: hsla(${hue}, 85%, 40%, 0.9);"></div>
              <div class="h-2.5" style="width: ${Math.max(0, pass3Pct - pass1Pct)}%; background-color: transparent; border: 2px solid hsla(${hue}, 85%, 45%, 0.8); border-left-width: 0px; box-sizing: border-box;"></div>
            </div>
          </div>
        `;

        if (this.type === 'model') {
          const logo = row.openrouter_slug ? row.openrouter_slug.split('/')[0] : 'unknown';
          const reasoning = row.is_reasoning ? '<i class="fa-solid fa-lightbulb text-slate-600 text-sm"></i>' : '';
          td2.innerHTML = `
            <div>
              <a class="flex items-center gap-x-2 text-blue-700 hover:text-blue-500" href="/models/${row.model}/">
                <img src="/assets/logos/${logo}.svg" alt="${row.model} logo" class="h-5 w-5 object-contain">
                <span>${row.model} ${reasoning}</span>
              </a>
              ${progressBarMobile}
            </div>
          `;
        } else {
          const wrapper = document.createElement('div');
          const link = document.createElement('a');
          link.href = `/tasks/${row.task_name}/`;
          link.className = 'text-blue-700 hover:text-blue-500 inline-block';
          link.textContent = row.task_name;
          wrapper.appendChild(link);
          
          // Show description below task name if enabled
          if (showDescriptionsBelowName && row.short_description) {
            const desc = document.createElement('div');
            desc.className = 'text-slate-600 text-sm mt-1';
            desc.textContent = row.short_description;
            wrapper.appendChild(desc);
          }
          
          wrapper.innerHTML += progressBarMobile;
          td2.appendChild(wrapper);
        }
        tr.appendChild(td2);

        // Success rate cell (hidden on mobile, shown on desktop)
        const td3 = document.createElement('td');
        td3.className = 'table-cell table-cell-rest table-cell-right hidden sm:table-cell';

        td3.innerHTML = `
          <div>
            <div class="text-right text-slate-800 tabular-nums text-sm">
              ${pass1Pct}% <span class="text-slate-500"> / ${pass3Pct}%</span>
            </div>
            <div class="w-full bg-slate-200 h-2 flex">
              <div class="h-2" style="width: ${pass1Pct}%; background-color: hsla(${hue}, 85%, 40%, 0.9);"></div>
              <div class="h-2" style="width: ${Math.max(0, pass3Pct - pass1Pct)}%; background-color: transparent; border: 2px solid hsla(${hue}, 85%, 45%, 0.8); border-left-width: 0px; box-sizing: border-box;"></div>
            </div>
          </div>
        `;
        tr.appendChild(td3);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const renderer = new RankingRenderer(data, type);
    // Sort by the initial sort column before first render
    renderer.sort(renderer.sortColumn);
  });
</script>